<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MY Visitor Reg</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f4f4f4; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        #reader { width: 100%; border-radius: 10px; overflow: hidden; margin-bottom: 20px; }
        input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        button { width: 100%; background: #008cba; color: white; padding: 15px; border: none; border-radius: 5px; font-weight: bold; margin-top: 10px; }
        #photo-result { width: 100%; margin-top: 10px; border-radius: 5px; display: none; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="card">
    <h2>Visitor Registration</h2>
    
    <div id="reader"></div>
    
    <label>Full Name (from ID)</label>
    <input type="text" id="visitor-name" placeholder="Waiting for scan...">
    
    <label>IC / Passport No.</label>
    <input type="text" id="visitor-ic" placeholder="Waiting for scan...">

    <hr>
    
    <video id="webcam" autoplay playsinline style="width:100%; display:none;"></video>
    <canvas id="canvas" class="hidden"></canvas>
    <img id="photo-result" src="">
    
    <button id="snap-btn" class="hidden">Take Photo</button>
    <button id="camera-trigger">Open Camera for Photo</button>
    <button id="submit-btn" style="background:#4CAF50; margin-top:30px;">Register Visitor</button>
</div>

<script>
   // 1. BARCODE SCANNING SETUP
const html5QrCode = new Html5Qrcode("reader");
const config = { fps: 10, qrbox: { width: 250, height: 150 } };

html5QrCode.start(
    { facingMode: "environment" }, 
    config,
    (decodedText) => {
        document.getElementById('visitor-ic').value = decodedText;
        html5QrCode.stop();
        document.getElementById('reader').innerHTML = "<p style='color:green'>✅ ID Scanned</p>";
    }
);

// 2. PHOTO CAPTURE LOGIC
const video = document.getElementById('webcam');
const canvas = document.getElementById('canvas');
const photoImg = document.getElementById('photo-result');
const cameraBtn = document.getElementById('camera-trigger');
const snapBtn = document.getElementById('snap-btn');

cameraBtn.addEventListener('click', async () => {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
        video.srcObject = stream;
        video.style.display = "block";
        snapBtn.classList.remove('hidden');
        cameraBtn.classList.add('hidden');
    } catch (err) {
        alert("Camera error: " + err);
    }
});

snapBtn.addEventListener('click', () => {
    // Set canvas to a smaller size to compress the photo for Google Sheets
    canvas.width = 400; 
    canvas.height = (video.videoHeight / video.videoWidth) * 400;
    
    canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
    
    // Use jpeg at 0.7 quality to keep file size tiny
    const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
    photoImg.src = dataUrl;
    photoImg.style.display = "block";
    
    video.srcObject.getTracks().forEach(track => track.stop());
    video.style.display = "none";
    snapBtn.classList.add('hidden');
});

// 3. SUBMISSION LOGIC (The Fixed Part)
document.getElementById('submit-btn').addEventListener('click', async () => {
    // Define visitorData INSIDE the click function
    const visitorData = {
        name: document.getElementById('visitor-name').value,
        ic: document.getElementById('visitor-ic').value,
        photo: photoImg.src
    };

    if(!visitorData.ic) {
        alert("Please scan ID first!");
        return;
    }

    document.getElementById('submit-btn').innerText = "Sending...";

    try {
        // We use 'fetch' inside an 'async' listener now
        await fetch('YOUR_GOOGLE_SCRIPT_URL_HERE', {
            method: 'POST',
            mode: 'no-cors', 
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(visitorData)
        });

        // Because of 'no-cors', it always goes straight to 'success' 
        // unless your internet is down.
        alert("Registration Submitted! Check your Google Sheet.");
        location.reload(); 

    } catch (error) {
        console.error("Submission Error:", error);
        alert("Failed to connect to Google Sheets.");
    }
});
</script>

</body>
</html>
