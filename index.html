// 1. BARCODE SCANNING SETUP
const html5QrCode = new Html5Qrcode("reader");
const config = { fps: 10, qrbox: { width: 250, height: 150 } };

html5QrCode.start(
    { facingMode: "environment" }, 
    config,
    (decodedText) => {
        document.getElementById('visitor-ic').value = decodedText;
        html5QrCode.stop();
        document.getElementById('reader').innerHTML = "<p style='color:green'>âœ… ID Scanned</p>";
    }
);

// 2. PHOTO CAPTURE LOGIC
const video = document.getElementById('webcam');
const canvas = document.getElementById('canvas');
const photoImg = document.getElementById('photo-result');
const cameraBtn = document.getElementById('camera-trigger');
const snapBtn = document.getElementById('snap-btn');

cameraBtn.addEventListener('click', async () => {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
        video.srcObject = stream;
        video.style.display = "block";
        snapBtn.classList.remove('hidden');
        cameraBtn.classList.add('hidden');
    } catch (err) {
        alert("Camera error: " + err);
    }
});

snapBtn.addEventListener('click', () => {
    // Set canvas to a smaller size to compress the photo for Google Sheets
    canvas.width = 400; 
    canvas.height = (video.videoHeight / video.videoWidth) * 400;
    
    canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
    
    // Use jpeg at 0.7 quality to keep file size tiny
    const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
    photoImg.src = dataUrl;
    photoImg.style.display = "block";
    
    video.srcObject.getTracks().forEach(track => track.stop());
    video.style.display = "none";
    snapBtn.classList.add('hidden');
});

// 3. SUBMISSION LOGIC (The Fixed Part)
document.getElementById('submit-btn').addEventListener('click', async () => {
    // Define visitorData INSIDE the click function
    const visitorData = {
        name: document.getElementById('visitor-name').value,
        ic: document.getElementById('visitor-ic').value,
        photo: photoImg.src
    };

    if(!visitorData.ic) {
        alert("Please scan ID first!");
        return;
    }

    document.getElementById('submit-btn').innerText = "Sending...";

    try {
        // We use 'fetch' inside an 'async' listener now
        await fetch('YOUR_GOOGLE_SCRIPT_URL_HERE', {
            method: 'POST',
            mode: 'no-cors', 
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(visitorData)
        });

        // Because of 'no-cors', it always goes straight to 'success' 
        // unless your internet is down.
        alert("Registration Submitted! Check your Google Sheet.");
        location.reload(); 

    } catch (error) {
        console.error("Submission Error:", error);
        alert("Failed to connect to Google Sheets.");
    }
});
